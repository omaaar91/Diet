<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø³Ø¹Ø±Ø§Øª ÙˆØ®Ø·Ø© Ø¯Ø§ÙŠØª ÙŠÙˆÙ…ÙŠØ©</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800&display=swap" rel="stylesheet">
  <!-- html2canvas & jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5lO+4w5G3wQ1iUD4C6AvqK7w3gq6qQz2e0XoYg0d6uo1zM1b1b3G2+eD2a2k3o3JpKj7m1G9O2G3I9G9s9w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/Fq0qTn9WQ8lFQ0j8m7f3xkQy+eXw3v6b0wQqXxFQ9g9Y1m6n6g1r7uP+E9E3t0w0zj4ZCwqzM1Zy6p5j3Y0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root { --radius: 18px; }
    *{ font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card{ border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0,0,0,.06); }
    .soft-border{ border:1px solid rgba(0,0,0,.06); }
    .pill{ border-radius: 999px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur soft-border">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-extrabold">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø³Ø¹Ø±Ø§Øª ÙˆØ®Ø·Ø© Ø¯Ø§ÙŠØª ÙŠÙˆÙ…ÙŠØ©</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Form -->
    <section class="card bg-white soft-border p-5">
      <h2 class="text-xl font-bold mb-3">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <label class="block">
          <span class="text-sm mb-1 block">Ø§Ù„Ù†ÙˆØ¹</span>
          <select id="gender" class="w-full rounded-xl border p-2.5">
            <option value="male">Ø°ÙƒØ±</option>
            <option value="female">Ø£Ù†Ø«Ù‰</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm mb-1 block">Ø§Ù„Ø¹Ù…Ø± (Ø³Ù†Ø©)</span>
          <input id="age" type="number" min="12" max="100" value="25" class="w-full rounded-xl border p-2.5"/>
        </label>
        <label class="block">
          <span class="text-sm mb-1 block">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</span>
          <input id="height" type="number" min="120" max="230" value="175" class="w-full rounded-xl border p-2.5"/>
        </label>
        <label class="block">
          <span class="text-sm mb-1 block">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</span>
          <input id="weight" type="number" min="30" max="300" value="75" class="w-full rounded-xl border p-2.5"/>
        </label>
        <label class="block">
          <span class="text-sm mb-1 block">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø·</span>
          <select id="activity" class="w-full rounded-xl border p-2.5">
            <option value="sedentary">Ù‚Ù„ÙŠÙ„ (Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠÙ† ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§)</option>
            <option value="light">Ø®ÙÙŠÙ (1â€“3 Ø£ÙŠØ§Ù… Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ‹Ø§)</option>
            <option value="moderate" selected>Ù…ØªÙˆØ³Ø· (3â€“5 Ø£ÙŠØ§Ù…)</option>
            <option value="active">Ø¹Ø§Ù„Ù (6â€“7 Ø£ÙŠØ§Ù…)</option>
            <option value="athlete">Ø±ÙŠØ§Ø¶ÙŠ (Ø´Ø§Ù‚)</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm mb-1 block">Ø§Ù„Ù‡Ø¯Ù</span>
          <select id="goal" class="w-full rounded-xl border p-2.5">
            <option value="maintain">Ø«Ø¨Ø§Øª</option>
            <option value="cut">ØªÙ†Ø´ÙŠÙ</option>
            <option value="bulk">ØªØ¶Ø®ÙŠÙ…</option>
          </select>
        </label>
      </div>
      <div class="mt-4 flex gap-2 flex-wrap">
        <button id="calcBtn" class="rounded-xl px-4 py-2.5 bg-black text-white hover:bg-gray-800">Ø§Ø­Ø³Ø¨</button>
        <button id="planBtn" class="rounded-xl px-4 py-2.5 border border-gray-300 hover:bg-gray-100">ÙˆÙ„Ù‘Ø¯ Ø®Ø·Ø© Ø¯Ø§ÙŠØª ÙŠÙˆÙ…ÙŠØ©</button>
        <button id="resetBtn" class="rounded-xl px-4 py-2.5 border border-gray-300 hover:bg-gray-100">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
    </section>

    <!-- Results summary -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="card bg-white soft-border p-5">
        <h3 class="text-lg font-bold mb-2">Ø§Ù„Ø­Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ BMR</h3>
        <div class="text-3xl font-black" id="bmrVal">â€”</div>
        <div class="text-sm text-gray-500 mt-1">Ù…Ø¹Ø§Ø¯Ù„Ø© Mifflin-St Jeor</div>
      </div>
      <div class="card bg-white soft-border p-5">
        <h3 class="text-lg font-bold mb-2">Ø§Ù„ØµØ±Ù Ø§Ù„ÙƒÙÙ„Ù‘ÙŠ TDEE</h3>
        <div class="text-3xl font-black" id="tdeeVal">â€”</div>
        <div class="text-sm text-gray-500 mt-1">ÙŠØ´Ù…Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
      </div>
      <div class="card bg-white soft-border p-5">
        <h3 class="text-lg font-bold mb-3">Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù‡Ø¯Ù</h3>
        <div class="space-y-1 text-sm" id="goalCals">
          <div class="flex items-center justify-between"><span>Ø«Ø¨Ø§Øª</span><span id="calMaintain">â€”</span></div>
          <div class="flex items-center justify-between"><span>ØªÙ†Ø´ÙŠÙ (-25%)</span><span id="calCut">â€”</span></div>
          <div class="flex items-center justify-between"><span>ØªØ¶Ø®ÙŠÙ… (+15%)</span><span id="calBulk">â€”</span></div>
        </div>
      </div>
    </section>

    <!-- Macros -->
    <section class="card bg-white soft-border p-5">
      <h3 class="text-lg font-bold mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø§ÙƒØ±ÙˆØ² Ø­Ø³Ø¨ Ø§Ù„Ù‡Ø¯Ù</h3>
      <div class="grid md:grid-cols-3 gap-4 text-center">
        <div class="rounded-xl bg-gray-100 p-4">
          <div class="text-sm text-gray-600">Ø¨Ø±ÙˆØªÙŠÙ†</div>
          <div class="text-2xl font-extrabold" id="macroProtein">â€”</div>
        </div>
        <div class="rounded-xl bg-gray-100 p-4">
          <div class="text-sm text-gray-600">ÙƒØ§Ø±Ø¨</div>
          <div class="text-2xl font-extrabold" id="macroCarb">â€”</div>
        </div>
        <div class="rounded-xl bg-gray-100 p-4">
          <div class="text-sm text-gray-600">Ø¯Ù‡ÙˆÙ†</div>
          <div class="text-2xl font-extrabold" id="macroFat">â€”</div>
        </div>
      </div>
    </section>

    <!-- Meal plan (render target) -->
    <section class="card bg-white soft-border p-5 hidden" id="planCard">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Ø®Ø·Ø© Ø¯Ø§ÙŠØª ÙŠÙˆÙ…ÙŠØ©</h3>
        <div class="text-sm text-gray-500">Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù‡Ø¯Ù: <span class="font-bold" id="planKcal">â€”</span></div>
      </div>

      <div id="planPrintable" class="space-y-4">
        <div id="mealsGrid" class="grid md:grid-cols-2 gap-4"></div>
        <div class="rounded-xl bg-yellow-50 border border-yellow-200 p-4 text-sm leading-7">
          <div class="font-bold mb-1">Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø©</div>
          <ul class="list-disc pr-6 space-y-1">
            <li>Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡ ÙƒÙØ§ÙŠØ© (2â€“3 Ù„ØªØ± ÙŠÙˆÙ…ÙŠÙ‹Ø§).</li>
            <li>Ø§Ù„Ù…Ø´ÙŠ 6â€“10 Ø¢Ù„Ø§Ù Ø®Ø·ÙˆØ© Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ù‡Ø¯Ù Ø§Ù„ØªÙ†Ø´ÙŠÙ.</li>
            <li>ÙˆØ²Ù† Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¨Ù†ÙØ³ Ø§Ù„ØªÙˆÙ‚ÙŠØª ÙŠØ¹Ø·ÙŠ Ù‚ÙŠØ§Ø³ Ø£Ø¯Ù‚.</li>
            <li>Ù†Ù… 7â€“8 Ø³Ø§Ø¹Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ø±Ù‚ ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ.</li>
          </ul>
        </div>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="pdfBtn" class="rounded-xl px-4 py-2.5 bg-black text-white hover:bg-gray-800">ØªÙ†Ø²ÙŠÙ„ PDF</button>
        <button id="regenBtn" class="rounded-xl px-4 py-2.5 border border-gray-300 hover:bg-gray-100">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯</button>
      </div>
    </section>

    <!-- Notes -->
    <section class="card bg-white soft-border p-5">
      <h3 class="text-lg font-bold mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©</h3>
      <ul class="list-disc pr-6 text-sm space-y-1 text-gray-600">
        <li>Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØªØ­ØªØ§Ø¬ Ø¶Ø¨Ø·Ù‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø®Ù„Ø§Ù„ 2â€“3 Ø£Ø³Ø§Ø¨ÙŠØ¹.</li>
        <li>ÙÙŠ Ø§Ù„ØªÙ†Ø´ÙŠÙ: Ù„Ùˆ Ø§Ù„ÙˆØ²Ù† Ø«Ø§Ø¨Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†ØŒ Ø¬Ø±Ù‘Ø¨ ØªÙ‚Ù„ÙŠÙ„ 100â€“150 Ùƒ.Ø³.</li>
        <li>ÙÙŠ Ø§Ù„ØªØ¶Ø®ÙŠÙ…: Ø§Ø³ØªÙ‡Ø¯Ù Ø²ÙŠØ§Ø¯Ø© 0.25â€“0.5 ÙƒØ¬Ù…/Ø£Ø³Ø¨ÙˆØ¹.</li>
      </ul>
    </section>

    <footer class="text-center text-xs text-gray-500 py-8">Â© <span id="year"></span> â€” Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ©</footer>
  </main>

<script>
// ===== Utilities =====
const $ = (id) => document.getElementById(id);
const fmt = (n) => Number.isFinite(n) ? n.toLocaleString('ar-EG') : 'â€”';

function mifflin({gender, age, heightCm, weightKg}){
  const base = 10*weightKg + 6.25*heightCm - 5*age;
  return gender==='male' ? base + 5 : base - 161;
}
function activityFactor(level){
  return ({sedentary:1.2, light:1.375, moderate:1.55, active:1.725, athlete:1.9})[level]||1.2;
}
function kcalToMacros({kcal, weightKg, goal}){
  const proteinPerKg = goal==='cut' ? 2.0 : goal==='bulk' ? 2.0 : 1.6;
  const proteinG = Math.round(proteinPerKg * weightKg);
  const proteinKcal = proteinG*4;
  const fatKcal = Math.round(kcal*0.25);
  const fatG = Math.round(fatKcal/9);
  const carbsKcal = Math.max(kcal - proteinKcal - fatKcal, 0);
  const carbsG = Math.round(carbsKcal/4);
  return {proteinG, fatG, carbsG};
}

const cheapSubs = {
  protein: [
    { name:'Ø¨ÙŠØ¶ Ù…Ø³Ù„ÙˆÙ‚', unit:'Ø¨ÙŠØ¶Ø©', grams:50, kcal:78, protein:6, icon:'ğŸ¥š' },
    { name:'ØªÙˆÙ†Ø© Ù…ØµÙØ§Ø© (Ø¹Ù„Ø¨Ø©)', unit:'Ø¹Ù„Ø¨Ø©', grams:140, kcal:160, protein:30, icon:'ğŸŸ' },
    { name:'ÙÙˆÙ„ Ù…Ø¯Ù…Ø³', unit:'ÙƒÙˆØ¨', grams:170, kcal:240, protein:12, icon:'ğŸ«˜' },
    { name:'Ø²Ø¨Ø§Ø¯ÙŠ Ù‚Ù„ÙŠÙ„ Ø§Ù„Ø¯Ø³Ù…', unit:'Ø¹Ù„Ø¨Ø©', grams:170, kcal:100, protein:10, icon:'ğŸ¥›' },
    { name:'Ø¬Ø¨Ù†Ø© Ù‚Ø±ÙŠØ´', unit:'100 Ø¬Ù…', grams:100, kcal:98, protein:11, icon:'ğŸ§€' },
    { name:'ØµØ¯ÙˆØ± ÙØ±Ø§Ø® Ù…Ø´ÙˆÙŠØ©', unit:'100 Ø¬Ù…', grams:100, kcal:165, protein:31, icon:'ğŸ—' },
  ],
  carbs: [
    { name:'Ø£Ø±Ø² Ø£Ø¨ÙŠØ¶ Ù…Ø³Ù„ÙˆÙ‚', unit:'ÙƒÙˆØ¨', grams:160, kcal:205, carbs:45, icon:'ğŸš' },
    { name:'Ø¹ÙŠØ´ Ø¨Ù„Ø¯ÙŠ', unit:'Ø±ØºÙŠÙ', grams:90, kcal:260, carbs:50, icon:'ğŸ¥–' },
    { name:'Ø¨Ø·Ø§Ø·Ø³ Ù…Ø³Ù„ÙˆÙ‚Ø©', unit:'Ø­Ø¨Ø©', grams:150, kcal:110, carbs:26, icon:'ğŸ¥”' },
    { name:'Ø´ÙˆÙØ§Ù†', unit:'Ù†ØµÙ ÙƒÙˆØ¨', grams:40, kcal:150, carbs:27, icon:'ğŸŒ¾' },
    { name:'Ù…ÙƒØ±ÙˆÙ†Ø© Ù…Ø³Ù„ÙˆÙ‚Ø©', unit:'ÙƒÙˆØ¨', grams:140, kcal:220, carbs:43, icon:'ğŸ' },
  ],
  fats: [
    { name:'Ø²ÙŠØª Ø²ÙŠØªÙˆÙ†', unit:'Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©', grams:14, kcal:119, fat:13.5, icon:'ğŸ«’' },
    { name:'Ø·Ø­ÙŠÙ†Ø©', unit:'Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©', grams:15, kcal:89, fat:8, icon:'ğŸ¥£' },
    { name:'ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ', unit:'Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©', grams:16, kcal:94, fat:8, icon:'ğŸ¥œ' },
    { name:'Ù…ÙƒØ³Ø±Ø§Øª Ù…Ø´ÙƒÙ„Ø©', unit:'30 Ø¬Ù…', grams:30, kcal:180, fat:16, icon:'ğŸ¥œ' },
  ],
};
function gramsToServing(targetG, item, macroKey){
  const per = item[macroKey]||0; if(!per) return {servings:0, kcal:0};
  const servings = Math.max(Math.round((targetG/per)*10)/10, 0);
  const kcal = Math.round(servings*item.kcal);
  return {servings, kcal};
}

function buildMealPlan({kcal, macros}){
  // 5 ÙˆØ¬Ø¨Ø§Øª: Ø¥ÙØ·Ø§Ø± 25%ØŒ Ø³Ù†Ø§Ùƒ 10%ØŒ ØºØ¯Ø§Ø¡ 35%ØŒ Ø³Ù†Ø§Ùƒ 10%ØŒ Ø¹Ø´Ø§Ø¡ 20%
  const splits = [0.25, 0.10, 0.35, 0.10, 0.20];
  const labels = ['Ø§Ù„Ø¥ÙØ·Ø§Ø±','Ø³Ù†Ø§Ùƒ','Ø§Ù„ØºØ¯Ø§Ø¡','Ø³Ù†Ø§Ùƒ','Ø§Ù„Ø¹Ø´Ø§Ø¡'];
  const meals=[];
  for(let i=0;i<splits.length;i++){
    const mkcal = Math.round(kcal*splits[i]);
    const mP = Math.round(macros.proteinG*splits[i]);
    const mF = Math.round(macros.fatG*splits[i]);
    const mC = Math.round(macros.carbsG*splits[i]);
    const p = cheapSubs.protein[i % cheapSubs.protein.length];
    const c = cheapSubs.carbs[i % cheapSubs.carbs.length];
    const f = cheapSubs.fats[i % cheapSubs.fats.length];
    const pCalc = gramsToServing(mP, p, 'protein');
    const cCalc = gramsToServing(mC, c, 'carbs');
    const fCalc = gramsToServing(mF, f, 'fat');
    meals.push({
      label: labels[i], kcal: mkcal, target:{protein:mP, carbs:mC, fat:mF},
      items:[ { ...p, macro:'Ø¨Ø±ÙˆØªÙŠÙ†', ...pCalc }, { ...c, macro:'ÙƒØ§Ø±Ø¨', ...cCalc }, { ...f, macro:'Ø¯Ù‡ÙˆÙ†', ...fCalc } ]
    });
  }
  return meals;
}

// ===== App State (simple) =====
const state = {
  form: { gender:'male', age:25, heightCm:175, weightKg:75, activity:'moderate', goal:'maintain' },
  results: null,
  plan: null,
};

// Load saved
(function loadSaved(){
  try{
    const saved = JSON.parse(localStorage.getItem('diet_planner_html')||'null');
    if(saved && saved.form){ state.form = { ...state.form, ...saved.form } }
  }catch{}
})();

// Apply form to inputs
(function initInputs(){
  $('gender').value = state.form.gender;
  $('age').value = state.form.age;
  $('height').value = state.form.heightCm;
  $('weight').value = state.form.weightKg;
  $('activity').value = state.form.activity;
  $('goal').value = state.form.goal;
  $('year').textContent = new Date().getFullYear();
})();

function recalc(){
  const form = {
    gender: $('gender').value,
    age: Number($('age').value),
    heightCm: Number($('height').value),
    weightKg: Number($('weight').value),
    activity: $('activity').value,
    goal: $('goal').value,
  };
  state.form = form;
  localStorage.setItem('diet_planner_html', JSON.stringify({form}));

  const bmr = Math.round(mifflin(form));
  const tdee = Math.round(bmr*activityFactor(form.activity));
  const calories = {
    maintain: tdee,
    cut: Math.round(tdee*0.75), // -25%
    bulk: Math.round(tdee*1.15), // +15%
  };
  const macros = {
    maintain: kcalToMacros({kcal: calories.maintain, weightKg: form.weightKg, goal:'maintain'}),
    cut: kcalToMacros({kcal: calories.cut, weightKg: form.weightKg, goal:'cut'}),
    bulk: kcalToMacros({kcal: calories.bulk, weightKg: form.weightKg, goal:'bulk'}),
  };
  state.results = { bmr, tdee, calories, macros };

  // Update UI
  $('bmrVal').textContent = fmt(bmr)+' Ùƒ.Ø³/ÙŠÙˆÙ…';
  $('tdeeVal').textContent = fmt(tdee)+' Ùƒ.Ø³/ÙŠÙˆÙ…';
  $('calMaintain').textContent = fmt(calories.maintain)+' Ùƒ.Ø³';
  $('calCut').textContent = fmt(calories.cut)+' Ùƒ.Ø³';
  $('calBulk').textContent = fmt(calories.bulk)+' Ùƒ.Ø³';

  const active = macros[form.goal];
  $('macroProtein').textContent = fmt(active.proteinG)+' Ø¬Ù…/ÙŠÙˆÙ…';
  $('macroCarb').textContent = fmt(active.carbsG)+' Ø¬Ù…/ÙŠÙˆÙ…';
  $('macroFat').textContent = fmt(active.fatG)+' Ø¬Ù…/ÙŠÙˆÙ…';
}

function renderPlan(){
  if(!state.results) recalc();
  const form = state.form;
  const kcal = state.results.calories[form.goal];
  const macros = state.results.macros[form.goal];
  const meals = buildMealPlan({kcal, macros});
  state.plan = {kcal, macros, meals, goal: form.goal};
  $('planKcal').textContent = fmt(kcal)+' Ùƒ.Ø³';

  const grid = $('mealsGrid');
  grid.innerHTML = '';
  meals.forEach((meal, idx)=>{
    const mealDiv = document.createElement('div');
    mealDiv.className = 'rounded-xl border p-4 bg-white/80 soft-border';
    mealDiv.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold">${meal.label}</div>
        <div class="text-xs text-gray-500">Ù‡Ø¯Ù: ${meal.target.protein}Ø¨ / ${meal.target.carbs}Ùƒ / ${meal.target.fat}Ø¯ â€¢ ~${meal.kcal} Ùƒ.Ø³</div>
      </div>
      <div class="space-y-3">
        ${meal.items.map(it => `
          <div class="flex items-start justify-between gap-3">
            <div class="text-sm">
              <div class="font-semibold">${it.macro}: ${it.icon||''} ${it.name}</div>
              <div class="text-gray-600">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©: <span class="font-bold">${it.servings}</span> Ã— ${it.unit} (~${it.grams}Ø¬Ù…)</div>
            </div>
            <div class="text-right text-xs text-gray-500">~ ${it.kcal} Ùƒ.Ø³</div>
          </div>
        `).join('')}
      </div>
      <details class="mt-3 text-sm">
        <summary class="cursor-pointer select-none font-medium">Ø¨Ø¯Ø§Ø¦Ù„ Ø±Ø®ÙŠØµØ©</summary>
        <div class="mt-2 grid grid-cols-3 gap-2">
          <div>
            <div class="text-xs text-gray-500 mb-1">Ø¨Ø±ÙˆØªÙŠÙ†</div>
            <select class="w-full border rounded-lg p-2 text-xs" data-kind="protein" data-idx="${idx}">
              ${cheapSubs.protein.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('')}
            </select>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">ÙƒØ§Ø±Ø¨</div>
            <select class="w-full border rounded-lg p-2 text-xs" data-kind="carbs" data-idx="${idx}">
              ${cheapSubs.carbs.map((c,i)=>`<option value="${i}">${c.name}</option>`).join('')}
            </select>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Ø¯Ù‡ÙˆÙ†</div>
            <select class="w-full border rounded-lg p-2 text-xs" data-kind="fats" data-idx="${idx}">
              ${cheapSubs.fats.map((f,i)=>`<option value="${i}">${f.name}</option>`).join('')}
            </select>
          </div>
        </div>
      </details>
    `;
    grid.appendChild(mealDiv);
  });

  // Hook change events for selects inside plan
  grid.querySelectorAll('select').forEach(sel=>{
    sel.addEventListener('change', (e)=>{
      const idx = Number(e.target.getAttribute('data-idx'));
      const kind = e.target.getAttribute('data-kind');
      const iSel = Number(e.target.value);
      const meal = state.plan.meals[idx];
      const keyMap = {protein:0, carbs:1, fats:2};
      const itemArr = cheapSubs[kind];
      const macroKey = kind==='protein' ? 'protein' : (kind==='carbs' ? 'carbs' : 'fat');
      const target = kind==='protein' ? meal.target.protein : kind==='carbs' ? meal.target.carbs : meal.target.fat;
      const chosen = itemArr[iSel];
      const calc = gramsToServing(target, chosen, macroKey);
      meal.items[keyMap[kind]] = { ...chosen, macro: kind==='protein'? 'Ø¨Ø±ÙˆØªÙŠÙ†' : kind==='carbs' ? 'ÙƒØ§Ø±Ø¨' : 'Ø¯Ù‡ÙˆÙ†', ...calc };
      renderPlan(); // re-render to reflect
    });
  });

  $('planCard').classList.remove('hidden');
}

async function downloadPDF(){
  const node = document.getElementById('planPrintable');
  const canvas = await html2canvas(node, {scale:2});
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jspdf.jsPDF({orientation:'p', unit:'mm', format:'a4'});
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const imgW = pageW;
  const imgH = canvas.height * imgW / canvas.width;
  let y = 0;
  pdf.addImage(imgData, 'PNG', 0, y, imgW, imgH);
  let remaining = imgH - pageH;
  while(remaining > 0){
    y -= pageH;
    pdf.addPage();
    pdf.addImage(imgData, 'PNG', 0, y, imgW, imgH);
    remaining -= pageH;
  }
  const goalTxt = {maintain:'Ø«Ø¨Ø§Øª', cut:'ØªÙ†Ø´ÙŠÙ', bulk:'ØªØ¶Ø®ÙŠÙ…'}[state.form.goal]||'Ø§Ù„Ø®Ø·Ø©';
  pdf.save(`Ø®Ø·Ø©-Ø¯Ø§ÙŠØª-ÙŠÙˆÙ…ÙŠØ©-${goalTxt}.pdf`);
}

// ===== Events =====
$('calcBtn').addEventListener('click', recalc);
$('planBtn').addEventListener('click', ()=>{ recalc(); renderPlan(); window.scrollTo({top: document.getElementById('planCard').offsetTop - 20, behavior:'smooth'}); });
$('regenBtn').addEventListener('click', ()=>{ renderPlan(); });
$('pdfBtn').addEventListener('click', downloadPDF);
$('resetBtn').addEventListener('click', ()=>{
  $('gender').value='male'; $('age').value=25; $('height').value=175; $('weight').value=75; $('activity').value='moderate'; $('goal').value='maintain';
  recalc();
});

// Auto-initial calc on load
recalc();
</script>
</body>
</html>
